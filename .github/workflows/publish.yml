name: Publish to NPM

on:
  push:
    branches: [ main, next ]
    paths: [ 'index.ts' ]
  workflow_dispatch:   

permissions:
  id-token: write      # Required for OIDC/provenance
  contents: write      # For git operations
  packages: write      # Required for GitHub Packages publish

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'

    - name: Update npm
      run: npm install -g npm@latest

    - name: Install TypeScript
      run: npm install -g typescript

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Check for actual type changes
      id: check-changes
      run: |
        # Compare current index.ts with previous commit
        if git show HEAD~1:index.ts > previous.ts 2>/dev/null; then
          if diff -q index.ts previous.ts > /dev/null; then
            echo "No actual changes to types content"
            echo "should-publish=false" >> $GITHUB_OUTPUT
          else
            echo "Types content has changed"
            echo "should-publish=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "Previous version not found, treating as new"
          echo "should-publish=true" >> $GITHUB_OUTPUT
        fi

    - name: Build dual packages
      if: steps.check-changes.outputs.should-publish == 'true'
      run: |
        echo "Building CommonJS and ES modules..."
        mkdir -p dist
        
        # CommonJS build
        tsc --module commonjs --target es2020 --outDir dist/cjs --declaration true index.ts
        mv dist/cjs/index.js dist/index.cjs
        
        # ES module build
        tsc --module es2020 --target es2020 --outDir dist/esm --declaration true index.ts
        mv dist/esm/index.js dist/index.mjs
        
        # Types (same for both)
        cp dist/cjs/index.d.ts dist/index.d.ts
        
        # Clean up temp dirs
        rm -rf dist/cjs dist/esm
        
        echo "Build verification:"
        ls -la dist/

    - name: Bump version and publish
      if: steps.check-changes.outputs.should-publish == 'true'
      id: bump-version
      run: |
        if [ ! -f package.json ]; then
          echo "package.json not found; aborting."
          exit 1
        fi

        # Decide behavior based on branch
        if [ "$GITHUB_REF_NAME" = "main" ]; then
          echo "Publishing stable release from main (latest)..."
          # Stable bump (patch for now)
          npm version patch --no-git-tag-version
          TAG="latest"
        else
          echo "Publishing prerelease from next (dist-tag: next)..."
          # Prerelease bump for staging
          npm version prerelease --preid next --no-git-tag-version
          TAG="next"
        fi

        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "New version: $NEW_VERSION (tag: $TAG)"
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

        # Publish using OIDC + provenance
        npm publish --provenance --access public --tag "$TAG"

        # Commit version bump & push
        git add package.json

        if [ "$GITHUB_REF_NAME" = "main" ]; then
          git commit -m "Bump version to $NEW_VERSION" || echo "No changes to commit"
          git tag "v$NEW_VERSION" || echo "Tag may already exist"
          git push origin main --tags || echo "Nothing to push"
        else
          git commit -m "chore: bump next version to $NEW_VERSION" || echo "No changes to commit"
          git push origin next || echo "Nothing to push"
        fi

    # =============================
    #   GitHub Packages Mirror
    # =============================
    - name: Mirror publish to GitHub Packages
      if: steps.check-changes.outputs.should-publish == 'true'
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üì¶ Publishing mirror to GitHub Packages..."

        # Configure temp .npmrc for GitHub Packages
        echo "@scoreboardmax:registry=https://npm.pkg.github.com" >> ~/.npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> ~/.npmrc

        # Determine which tag to use based on branch
        if [ "$GITHUB_REF_NAME" = "main" ]; then
          PUBLISH_TAG="latest"
        else
          PUBLISH_TAG="next"
        fi

        # Publish with the appropriate tag
        npm publish --tag "$PUBLISH_TAG"

        echo "‚úÖ Successfully published to GitHub Packages with tag: $PUBLISH_TAG"

    - name: Create GitHub release (stable only)
      if: steps.check-changes.outputs.should-publish == 'true' && github.ref_name == 'main'
      run: |
        gh release create "v${{ steps.bump-version.outputs.new-version }}" \
          --title "v${{ steps.bump-version.outputs.new-version }}" \
          --notes "Automated release of ScoreboardMax API types

        Generated from API repository changes.
        
        üì¶ Dual package support:
        - CommonJS: \`require('@scoreboardmax/api-types')\`
        - ES6: \`import {} from '@scoreboardmax/api-types'\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        if [ "${{ steps.check-changes.outputs.should-publish }}" != "true" ]; then
          echo "‚ÑπÔ∏è No changes detected in index.ts, skipping publish"
        else
          if [ "$GITHUB_REF_NAME" = "main" ]; then
            echo "‚úÖ Published @scoreboardmax/api-types@${{ steps.bump-version.outputs.new-version }} to NPM (latest)"
            echo "üì¶ Mirrored to GitHub Packages as well"
          else
            echo "‚úÖ Published @scoreboardmax/api-types@${{ steps.bump-version.outputs.new-version }} to NPM with dist-tag \"next\""
            echo "üì¶ Mirrored to GitHub Packages with dist-tag \"next\""
          fi
        fi
