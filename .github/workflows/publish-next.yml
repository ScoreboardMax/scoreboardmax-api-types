name: Publish to NPM (next)

on:
  push:
    branches: [ next ]
    paths: [ 'index.ts' ]
  workflow_dispatch:

permissions:
  id-token: write      # Required for OIDC
  contents: write      # For git operations

jobs:
  publish-next:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'

    - name: Update npm
      run: npm install -g npm@latest

    - name: Install TypeScript
      run: npm install -g typescript

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Check for actual type changes
      id: check-changes
      run: |
        # Compare current index.ts with previous commit's version
        if git show HEAD~1:index.ts > previous.ts 2>/dev/null; then
          if diff -q index.ts previous.ts > /dev/null; then
            echo "No actual changes to types content"
            echo "should-publish=false" >> $GITHUB_OUTPUT
          else
            echo "Types content has changed"
            echo "should-publish=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "No previous index.ts found, treating as new"
          echo "should-publish=true" >> $GITHUB_OUTPUT
        fi

    - name: Build dual packages
      if: steps.check-changes.outputs.should-publish == 'true'
      run: |
        echo "Building CommonJS and ES modules for next..."
        mkdir -p dist
        
        # CommonJS build
        tsc --module commonjs --target es2020 --outDir dist/cjs --declaration true index.ts
        mv dist/cjs/index.js dist/index.cjs
        
        # ES module build
        tsc --module es2020 --target es2020 --outDir dist/esm --declaration true index.ts
        mv dist/esm/index.js dist/index.mjs
        
        # Types (same for both)
        cp dist/cjs/index.d.ts dist/index.d.ts
        
        # Clean up temp dirs
        rm -rf dist/cjs dist/esm
        
        echo "Build verification:"
        ls -la dist/

    - name: Bump prerelease version and publish with dist-tag next
      if: steps.check-changes.outputs.should-publish == 'true'
      id: bump-version
      run: |
        if [ ! -f package.json ]; then
          echo "package.json not found; aborting."
          exit 1
        fi

        # Bump to a prerelease, e.g. 1.5.4-next.0, 1.5.4-next.1, etc.
        npm version prerelease --preid next --no-git-tag-version
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "New prerelease version: $NEW_VERSION"
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

        # Publish with the "next" dist-tag so it doesn't overwrite "latest"
        npm publish --provenance --access public --tag next

        # Commit the version bump back to next branch (optional but nice)
        git add package.json
        git commit -m "chore: bump next version to $NEW_VERSION" || echo "No changes to commit"
        git push origin next || echo "Nothing to push"

    - name: Summary
      run: |
        if [ "${{ steps.check-changes.outputs.should-publish }}" != "true" ]; then
          echo "ℹ️ No changes detected in index.ts, skipping publish"
        else
          echo "✅ Published @scoreboardmax/api-types@${{ steps.bump-version.outputs.new-version }} with dist-tag \"next\""
          echo "   Install via: npm install @scoreboardmax/api-types@next"
        fi
